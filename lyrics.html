<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>syncdeeznotes | hoshinetsu</title>
    <link rel="Stylesheet" href="bootstrap.min.css">
    <style>
         :root {
            color-scheme: dark;
        }
        
         ::-webkit-scrollbar {
            display: block;
            width: 10px;
            background-color: #1a1a1a;
        }
        
         ::-webkit-scrollbar-thumb {
            background-color: #aaa;
            background-clip: padding-box;
            border-radius: 9999px;
            border: 2px solid rgba(0, 0, 0, 0);
        }
        
        body,
        header,
        main {
            background-color: #222;
        }
        
        header {
            color: #eee;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        main {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        
        .lyrics-wrapper {
            color: #7a7a7a;
            font-size: 20px;
            user-select: none;
            word-wrap: normal;
            word-break: keep-all;
            overflow-y: scroll;
            scroll-behavior: smooth;
            margin-bottom: 120px;
            margin-top: 80px;
        }
        
        h1 {
            margin: 10px 0;
            width: fit-content;
            cursor: pointer;
            font-weight: bolder;
            transition-duration: 300ms;
            text-shadow: 3px 3px 1px #2a2a2a;
        }
        
        h1:hover {
            text-shadow: 3px 3px 1px #444;
        }
        
        .active {
            color: #eee;
            text-shadow: 3px 3px 1px #3a3a3a;
        }
        
        .active:hover {
            text-shadow: 3px 3px 1px #999;
        }
        
        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            background-color: #1a1a1a;
            border-top: 1px solid #666;
        }
        
        .controls .flx {
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #syncButton {
            padding: 15px;
        }
        
        .song {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            color: #7a7a7a;
            font-family: monospace;
        }
        
        .song p {
            line-height: 1.1em;
            margin: 0;
            text-align: left;
        }
        
        .song * b {
            color: #bbb;
        }
        
        h6 {
            margin: 0;
        }
        
        .mode-off {
            display: none;
        }
        
        .mode-on {}
        
        audio {
            width: 100%;
        }
        
        .ptr {
            cursor: pointer;
        }
        
        .player-blk {
            align-self: center;
            flex: 1;
            display: flex;
            flex-direction: row;
            justify-content: center;
            color: #ccc;
            gap: 10px;
        }
        
        .modesw {
            text-align: center;
        }
        
        .modesw h4,
        .modesw a {
            transition-duration: 300ms;
        }
        
        .modesw h4:hover,
        .modesw a:hover {
            text-shadow: 0px 0px 5px #aaa;
        }
        
        .modesw a {
            color: #666;
        }
        
        h2 small {
            font-size: 0.5em;
            vertical-align: middle;
            height: 100%;
        }
        
        h2 small::before {
            content: ' \2022  ';
        }
        
        #err {
            color: red;
        }
        
        .lock {
            display: inline-block;
        }
        
        .lock * {
            vertical-align: middle;
        }
    </style>
</head>

<body>
    <header class="container-fluid">
        <div class="row">
            <div class="col-12 col-md-6 text-start song">
                <p>::song <b id="xsong"></b></p>
                <p>::by <b id="xby"></b>
            </div>
            <div class="col-12 col-md-6 text-end song">
                <h6>::app <b>syncdeeznotes</b> ver. 1.4.2.0-ALF</h6>
                <h6>::dev <b><a href="https://hoshinetsu.moe" class="text-secondary" target="_blank">@hoshinetsu</a></b>
                </h6>
            </div>
        </div>
    </header>
    <main class="container">
        <div class="row lyrics-wrapper">
            <div class="lyrics col-12"></div>
        </div>
    </main>
    <footer class="container-fluid controls">
        <div class="row px-5">
            <div class="col-2 song ptr flx">
                <div class="modesw">
                    <div class="lock" title="Prevents accidental switching & loss of syncing work"><label>::lock current
                            mode:</label>&nbsp;<input type="checkbox" id="xlock" checked></div>
                    <div id="mode_pb">
                        <h4 onclick="modeSwitch()" title="Switch to sync mode"><b>playback</b>::<b>mode</b></h4>
                    </div>
                    <div id="mode_sc" class="mode-off" title="Switch to playback mode">
                        <h4 onclick="modeSwitch()"><b>sync</b>::<b>mode</b></h4>
                        <a href="javascript:getJson()" title="Export synced lyrics">save::lyrics</a>
                    </div>
                </div>
            </div>
            <div class="col-8 flx"><audio id="track" controls ontimeupdate="updateTime()">
                    <source src="ur_my_drug_i_luv_u.mp3" type="audio/mpeg">
                </audio>
                <!-- <div class="player-container">
                    <div class="player-blk">
                        <button id="player-play">></button>
                        <span id="player-pos">0:00</span>
                        <input type="range" id="player-seek" max="100" value="0">
                        <span id="player-len">0:00</span>
                    </div>
                    <div class="player-blk">
                        <span id="player-vol">15</span>
                        <input type="range" id="player-dial" max="100" value="15">
                    </div>
                </div> -->
            </div>
            <div class="col-2 song flx">meow meow</div>
        </div>
    </footer>
    <script>
        const container = document.querySelector(".lyrics");
        const track = document.getElementById("track");
        track.volume = 0.15;
        var song;
        var by;
        var lyrics = [];
        var currentLine = -1;
        var lastLine = -1;
        var syncMode = false;

        async function modeSwitch() {
            if (document.getElementById("xlock").checked) {
                alert("Mode is locked to prevent accidental switching.\r\nUnlock current mode and switch again.");
            } else {
                document.getElementById("xlock").checked = true;
                track.pause();
                track.currentTime = 0
                setLine(0)

                syncMode = !syncMode;
                if (syncMode) {
                    document.getElementById("mode_sc").setAttribute("class", "mode-on");
                    document.getElementById("mode_pb").setAttribute("class", "mode-off");

                } else {
                    document.getElementById("mode_sc").setAttribute("class", "mode-off");
                    document.getElementById("mode_pb").setAttribute("class", "mode-on");
                }
                for (let x = 0; x < lyrics.length; x++)
                    reloadLyrics(x)
            }
        }

        /* load lyrics file */
        function loadSong(file) {
            fetch(file).then((response) => response.json()).then(function(json) {
                document.getElementById("xsong").innerHTML = song = json.song;
                document.getElementById("xby").innerHTML = by = json.by;
                lyrics[0] = ["::[play-song]", -0.15];
                Object.values(json.lyrics).forEach((line, value) => lyrics[value + 1] = [line[0],
                    line[1]
                ]);
                loadLyrics();
            }, function(reason) {
                writeLine("err", "error: malformed song JSON");
            });
        }

        function writeLine(id, txt) {
            const line = document.createElement("h1");
            line.setAttribute("id", id);
            line.setAttribute("onclick", "jumpTo(this.id)")
            line.innerText = txt;
            container.appendChild(line);
        }

        try {
            loadSong("drugs.json");
        } catch (error) {
            writeLine("err", "error: unable to load the song metadata.");
        }

        /* display the lyrics */
        function loadLyrics() {
            for (let x = 0; x < lyrics.length; x++) {
                writeLine(x, lyrics[x][0])
            }
        }

        /* play the music and sync lyrics */
        function updateTime() {
            if (syncMode) return;
            let line = currentLine;
            while (line < lyrics.length - 1 && track.currentTime >= lyrics[line + 1][1]) {
                line++;
            }
            while (line > 0 && track.currentTime < lyrics[line][1]) {
                line--;
            }
            setLine(line)
        }

        function syncLine(line) {
            if (syncMode && line < lyrics.length) {
                let time = track.currentTime - 0.3;
                lastTime = time;
                lyrics[line][1] = time;
                reloadLyrics(line)
                setLine(Math.min(line, lyrics.length - 1))
            }
        }

        function reloadLyrics(x) {
            if (syncMode)
                document.getElementById(x).innerHTML = "<h2>" + lyrics[x][0] + "<small>" + lyrics[x][1] + "</small></h2>";
            else
                document.getElementById(x).innerHTML = lyrics[x][0];
        }

        function setLine(line) {
            console.log("xSet line " + line)
            if (currentLine != line) {
                lastLine = currentLine;
                currentLine = line;
                updateLyricsDisplay()
            }
        }

        function scrollToLine(line) {
            let pct = line - 1;
            const box = document.querySelector('.lyrics-wrapper');
            box.scroll(0, pct * 48)
        }

        function updateLyricsDisplay() {
            for (let x = lyrics.length - 1; x >= currentLine; x--) {
                document.getElementById(x).removeAttribute("class");
            }
            for (let x = 0; x <= currentLine; x++) {
                document.getElementById(x).setAttribute("class", "active");
                if (syncMode) {
                    reloadLyrics(x);
                }
            }
            scrollToLine(currentLine)
        }

        function jumpTo(line) {
            if (syncMode) {
                if (line == 0) {
                    track.currentTime = 0;
                    track.play();
                }
                let target = line;
                if (line <= 1 && currentLine <= 1) {
                    target = 1;
                }
                syncLine(target);
            } else {
                track.play();
                track.currentTime = lyrics[line][1] + 0.15;
            }
        }

        function getJson() {
            let json = [];
            json.push('{', '"song":"', song, '","by":"', by, '","lyrics":', JSON.stringify(lyrics.slice(1)), '}');
            textFile("Lyrics of " + song + ".json", json.join(""))
        }

        function textFile(file, content) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
            element.setAttribute('download', file);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }
    </script>
</body>

</html>