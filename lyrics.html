<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lyrics syncer BETA | hoshinetsu</title>
    <link rel="Stylesheet" href="bootstrap.min.css">
    <style>
         :root {
            color-scheme: dark;
        }
        
        body {
            background-color: #222;
        }
        
        header {
            color: #eee;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        main {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        
        .lyrics-wrapper {
            color: #9a9a9a;
            font-size: 20px;
            user-select: none;
            word-wrap: normal;
            word-break: keep-all;
            overflow-y: scroll;
            scroll-behavior: smooth;
            margin-bottom: 150px;
            margin-top: 80px;
        }
        
        h1 {
            margin: 10px 0;
            width: fit-content;
            cursor: pointer;
            font-weight: bolder;
        }
        
        #L0 {
            display: none;
        }
        
        .active {
            color: #eee;
        }
        
        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            background-color: #1a1a1a;
            border-top: 1px solid #666;
        }
        
        .controls div div {
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #syncButton {
            padding: 15px;
        }
        
        .song {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            color: #7a7a7a;
            font-family: monospace;
        }
        
        .song p {
            line-height: 1.1em;
            margin: 0;
            text-align: left;
        }
        
        .song * b {
            color: #bbb;
        }
        
        h6 {
            margin: 0;
        }
        
        .mode-off {
            display: none;
        }
        
        .mode-on {}
        
        audio {
            width: 100%;
        }
        
        .ptr {
            cursor: pointer;
        }
    </style>
</head>

<body>
    <header class="container-fluid">
        <div class="row">
            <div class="col-12 col-md-6 text-start song">
                <p>::song <b>ur my drug i luv u</b></p>
                <p>::by <b>hoshie star, roninkys</b>
            </div>
            <div class="col-12 col-md-6 text-end song">
                <h6>::app <b>syncdeeznotes</b> ver. 1.4.2.0-ALF</h6>
                <h6>::dev <b><a href="https://hoshinetsu.moe" class="text-secondary" target="_blank">@hoshinetsu</a></b>
                </h6>
            </div>
        </div>
    </header>
    <main class="container">
        <div class="row lyrics-wrapper">
            <div class="lyrics col-12"></div>
        </div>
    </main>
    <footer class="container-fluid controls">
        <div class="row px-5">
            <div class="col-2 song ptr">
                <div class="song" onclick="modeSwitch()">
                    <h4 id="mode_pb"><b>playback</b>::<b>mode</b></h4>
                    <h4 id="mode_sc" class="mode-off"><b>sync</b>::<b>mode</b><br>(not <br>implemented yet)</h4>
                    </p>
                </div>
            </div>
            <div class="col-8"><audio id="track" controls ontimeupdate="updateTime()">
                    <source src="ur_my_drug_i_luv_u.mp3" type="audio/mpeg">
                </audio>
            </div>
            <div class="col-2 song">meow meow</div>
        </div>
    </footer>
    <script>
        const track = document.getElementById("track");
        const container = document.querySelector(".lyrics");
        track.volume = 0.25;
        var lyrics = [];
        var currentLine = 0;
        var lastLine = 0;
        var editMode = false;

        function modeSwitch() {
            editMode = !editMode;
            if (editMode) {
                document.getElementById("mode_sc").setAttribute("class", "mode-on");
                document.getElementById("mode_pb").setAttribute("class", "mode-off");
                alert("Work in progress, edit mode ain't available yet.\r\nBut enjoy the toggle effect! ;3");
            } else {
                document.getElementById("mode_sc").setAttribute("class", "mode-off");
                document.getElementById("mode_pb").setAttribute("class", "mode-on");
            }

        }

        /* load lyrics file */
        fetch("drugs.json").then((response) => response.json()).then(function(json) {
            lyrics[0] = ["chuj", 0];
            Object.values(json.lyrics).forEach((line, value) => lyrics[value + 1] = [line.text,
                line.time
            ]);
            displayLyrics()
        });


        /* display the lyrics */
        function displayLyrics() {
            for (let x = 0; x < lyrics.length; x++) {
                const line = document.createElement("h1");
                line.setAttribute("id", "L" + x);
                line.setAttribute("onclick", "jumpTo(this.id)")
                line.innerText = lyrics[x][0];
                container.appendChild(line);
            }
        }
        /* play the music and sync lyrics */
        function updateTime() {
            while (currentLine < lyrics.length - 1 && track.currentTime > lyrics[currentLine + 1][1]) {
                currentLine++;
            }
            while (currentLine > 0 && track.currentTime < lyrics[currentLine][1]) {
                currentLine--;
            }
            setLine(currentLine)
        }

        let syncingLine = 0;
        let jsonCode = '{"lyrics":{';
        async function syncLine() {
            if (syncingLine < lyrics.length) {
                lyrics[syncingLine][1] = track.currentTime;
                setLine(syncingLine);
                xJsonCode = '"' + syncingLine + '":{"text":"' + lyrics[syncingLine][0] + '", "time":' + track.currentTime + "}";
                console.log(lyrics[syncingLine][0] + " " + lyrics[syncingLine][1]);
                if (syncingLine + 1 == lyrics.length) {
                    jsonCode += xJsonCode + '}}';
                    const codeEl = document.createElement("code");
                    codeEl.innerText = jsonCode;
                    container.appendChild(codeEl);
                } else {
                    jsonCode += xJsonCode + ",";
                }
                syncingLine++;
            }
        }

        function setLine(line) {
            console.log("CL:" + line);
            lastLine = currentLine;
            currentLine = line;
            updateLyricsDisplay()
        }

        function updateLyricsDisplay() {
            for (let x = lyrics.length - 1; x >= currentLine; x--) {
                document.getElementById("L" + x).setAttribute("class", "");
            }
            for (let x = 0; x <= currentLine; x++) {
                document.getElementById("L" + x).setAttribute("class", "active");
            }

            document.getElementById("L" + currentLine).scrollIntoView();
        }

        function jumpTo(line) {
            console.log("jumping to " + line);
            setLine.apply(this, arguments);
            track.currentTime = lyrics[line][1];
        }
    </script>
</body>

</html>